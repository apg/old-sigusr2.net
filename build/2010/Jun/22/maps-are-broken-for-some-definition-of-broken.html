<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="en-us" />
    <meta name="ROBOTS" content="all" />
    <meta name="googlebot" content="noodp" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="Copyright" content="Copyright 2008 Andrew Gwozdziewycz" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="Andrew Gwozdziewycz" />
    <link rel="alternate" title="Latest Entries Atom" href="/atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="/favicon.ico" />        

    <link rel="stylesheet" href="http://sigusr2.net/css/screen.css" media="screen,projector" type="text/css" />
    <link rel="stylesheet" href="/css/today.css" media="screen,projector" type="text/css" />
    <title>SIGUSR2 
 &gt; Maps are Broken, for Some Definition of Broken
</title>
</head>
<body>
  <div id="wrapper">
    <div id="header">
      <h1><a href="/" title="SIGUSR2">SIGUSR2</a></h1>
    </div>
    <div id="content-wrapper" class="clearfix">
      <div id="content">
        
<h2>Maps are Broken, for Some Definition of Broken</h2>
<h4>June 22, 2010 <span class="permalink"><a href="/2010/Jun/22/maps-are-broken-for-some-definition-of-broken.html" title="permalink">#</a></span></h4>
<p><span class="preamble">Map datatypes are extremely useful for a variety of tasks in programming. But, they are often painful to use; take for example the following task.</span></p>

<p>In Java, I have a <a href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/HashMap.html">HashMap</a> and I wish to get a random key. Well, <a href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/AbstractMap.html">AbstractMap</a> doesn't define a way to get a random key, but it does provide a way to get a <a href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/Set.html">Set</a> of keys. Does Set have a way to get a random element? No, but you can create an Array from a Set with the <code class="inline">toArray()</code> method on Set.</p>

<p>We end up with the following:</p>

<pre><code>public String randomKey() {
    // Assuming: map = HashMap&lt;String, String&gt;;
    Set&lt;String&gt; set = map.keySet();
    Object[] strings = set.toArray();
    Random random = new Random();
    if (strings.length &gt; 0) {
        return (String)strings[random.nextInt(strings.length)];
    }
    return null;
}
</code></pre>

<p>Now, this isn't necessarily bad, but we have to create a new array, and a new set each time we want a random key. We can of course be smarter about this by caching the array and/or set, but then we run into synchronization issues. We also get screwed when we attempt to implement the <code class="inline">popRandom()</code> operation, which could be implemented like so:</p>

<pre><code>public String popRandom() {
    String key = randomKey();
    if (key != null) {
        String value = map.get(key);
        map.remove(key);
        return value;
    }
    return null; // or more appropriately, throw an exception
}
</code></pre>

<p>So, we're doing all this extra copying, allocating and deleting, when all we really need is an iterator, to solve this generically in <code class="inline">O(n)</code> time.</p>

<pre><code>public String randomKey() {
    // randomKey method in O(n) using imaginary iterator() on AbstractMap
    int size = map.size();
    if (size &gt; 0) {
        int index = new Random().randInt(size);
        Iterator&lt;String&gt; keys = map.iterator();
        while (keys.hasNext()) {
           if (index-- == 0) {
               return keys.next();
           }
           keys.next();
        }
    }
    return null;
}
</code></pre>


<p>This sort of thing isn't necessarily true for dynamic languages like Python which normally have ways to iterate over keys in a map, dictionary or set. They still don't have a way to get a random element from either out of the box without resulting to the <code class="inline">O(n)</code> iteration method, or converting to a list and using a random index approach.</p>

<pre><code>&gt;&gt;&gt; import random
&gt;&gt;&gt; random.choice(set([1, 2, 3]))
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/System/Library/Frameworks/Python.framework/Versions/2.5/lib/python2.5/random.py", line 248, in choice
    return seq[int(self.random() * len(seq))]  # raises IndexError if seq is empty
TypeError: 'set' object is unindexable
</code></pre>

<pre><code>&gt;&gt;&gt; random.choice({'1': 'world', '2': 'galaxy', '3': 'universe'})
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/System/Library/Frameworks/Python.framework/Versions/2.5/lib/python2.5/random.py", line 248, in choice
    return seq[int(self.random() * len(seq))]  # raises IndexError if seq is empty
KeyError: 2
</code></pre>

<p>And of course that makes sense given how <code class="inline">random.choice</code> is implemented, since there's not necessarily  an order for the elements of a set or dictionary, so you can't expect to subscript them. However they do provide an order when iterating over them and traversing the structure they exist in, so you could certainly use the same <code class="inline">O(n)</code> approach from above.</p>

<p>If there's some other less obvious way to do this in Java using a <a href="http://en.wikipedia.org/w/index.php?title=Dependency_injection&oldid=260831402#A_code_illustration_using_Java">EnterpriseFactoryObserverFactoryFactoryCreator</a>, please leave a comment.</p>


<p><strong>Update: I overlooked something important, which was pointed out by <a href="http://news.ycombinator.com/item?id=1452619">gojomo</a> on Hacker News. Set, which is returned from <code class="inline">keySet()</code> on HashMap, has an iterator. Thus:</strong></p>

<pre><code>public String randomKey() {
    int index = random.nextInt(map.size());
    for (String key: map.keySet()) {
        if (index-- == 0) {
            return key;
        }
    }
    return null;
}
</code></pre>


<h5 class="tag-list">Tagged: 
  <a href="/tags/algorithms.html">algorithms</a>
     , <a href="/tags/java.html">java</a>
     , <a href="/tags/python.html">python</a>
     , <a href="/tags/rant.html">rant</a>
     
</h5>

<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/sigusr2/embed.js"></script><noscript><a href="http://sigusr2.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
      <div id="sidebar">
        <h2>About</h2>
        <p>
          Hi, I'm <a href="http://apgwoz.com" title="My Homepage">Andrew</a>. I sometimes use this space to write about things I'm doing related to programming.
        </p>
        <p>
          You should follow me on <a href="http://twitter.com/apgwoz">Twitter</a>.
        </p>
	<h2>Inside</h2>
	<ul>
          <li><a href="/page/man.html" title="man page for signal(7)">man signal(7)</a></li>
	</ul>
       <ul>
          <li>
       <!--Ad Bard advertisement snippet, begin -->
       <script type='text/javascript'>
          var ab_h = '65997c9b7b5981e3cf2ebec769eea096';
          var ab_s = '7a46f7b695d2481693fe4724f778884a';
       </script>
       <script type='text/javascript' src='http://cdn1.adbard.net/js/ab1.js'></script>
       <!--Ad Bard, end -->
          </li>
       </ul>

        <h2>Syndicate</h2>
        <ul>
          <li><a href="/atom.xml" title="Atom Feed">Atom</a></li>
        </ul>
        <h2>Archives</h2>
        <ul>
        
        <li><a href="/2011/Apr/" title="April 2011 (1)">April 2011 (1)</a></li>
        
        <li><a href="/2011/Jan/" title="January 2011 (1)">January 2011 (1)</a></li>
        
        <li><a href="/2010/Nov/" title="November 2010 (1)">November 2010 (1)</a></li>
        
        <li><a href="/2010/Oct/" title="October 2010 (3)">October 2010 (3)</a></li>
        
        <li><a href="/2010/Jun/" title="June 2010 (3)">June 2010 (3)</a></li>
        
        <li><a href="/2010/Apr/" title="April 2010 (1)">April 2010 (1)</a></li>
        
        <li><a href="/2010/Jan/" title="January 2010 (1)">January 2010 (1)</a></li>
        
        <li><a href="/2009/Nov/" title="November 2009 (1)">November 2009 (1)</a></li>
        
        <li><a href="/2009/Oct/" title="October 2009 (1)">October 2009 (1)</a></li>
        
        <li><a href="/2009/Sep/" title="September 2009 (1)">September 2009 (1)</a></li>
        
        <li><a href="/2009/Jul/" title="July 2009 (1)">July 2009 (1)</a></li>
        
        <li><a href="/2009/May/" title="May 2009 (1)">May 2009 (1)</a></li>
        
        <li><a href="/2009/Apr/" title="April 2009 (1)">April 2009 (1)</a></li>
        
        <li><a href="/2009/Mar/" title="March 2009 (1)">March 2009 (1)</a></li>
        
        <li><a href="/2009/Feb/" title="February 2009 (1)">February 2009 (1)</a></li>
        
        <li><a href="/2009/Jan/" title="January 2009 (1)">January 2009 (1)</a></li>
        
        <li><a href="/2008/Dec/" title="December 2008 (1)">December 2008 (1)</a></li>
        
        <li><a href="/2008/Sep/" title="September 2008 (3)">September 2008 (3)</a></li>
        
        </ul>
      </div>
    </div>

    <div id="footer">
       &copy; 2009 <a href="http://apgwoz.com/">Andrew Gwozdziewycz</a>, I like bees. Powered by Modest. Not tested in IE, because it sucks.
    </div>
  </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-354660-9");
pageTracker._trackPageview();
</script>
</body>
</html>