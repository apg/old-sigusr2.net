<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Language" content="en-us" />
    <meta name="ROBOTS" content="all" />
    <meta name="googlebot" content="noodp" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="Copyright" content="Copyright 2008 Andrew Gwozdziewycz" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="Andrew Gwozdziewycz" />
    <link rel="alternate" title="Latest Entries Atom" href="/atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="/favicon.ico" />        

    <link rel="stylesheet" href="http://sigusr2.net/css/screen.css" media="screen,projector" type="text/css" />
    <link rel="stylesheet" href="/css/today.css" media="screen,projector" type="text/css" />
    <title>SIGUSR2 
 &gt; Pattern Matching with &#34;With&#34;
</title>
</head>
<body>
  <div id="wrapper">
    <div id="header">
      <h1><a href="/" title="SIGUSR2">SIGUSR2</a></h1>
    </div>
    <div id="content-wrapper" class="clearfix">
      <div id="content">
        
<h2>Pattern Matching with &#34;With&#34;</h2>
<h4>April 28, 2010 <span class="permalink"><a href="/2010/Apr/28/pattern-matching-with-with.html" title="permalink">#</a></span></h4>
<p>
<span class="preamble">When I originally thought about adding pattern matching to Python, in the <a href="http://sigusr2.net/2008/Sep/30/python-type-constructors-like-ocaml.html">OCaml sense</a>, I ended up using a decorator that more or less registed a bunch of callbacks with a dispatch table based on the types of it's arguments.</span>
</p>

<p>That worked out fine, but it didn't really have the feel of <a href="http://en.wikipedia.org/wiki/Pattern_matching">pattern matching</a> like you get with real <a href="http://en.wikipedia.org/wiki/Algebraic_data_type">algebraic data types</a>. If you recall, I was playing with the following example with the decorator approach:
</p>

<pre><code class="ocaml">type astnode = 
| AndNode of astnode * astnode
| OrNode of astnode * astnode
| NotNode of astnode 
| IdNode of bool

let rec eval_node (n: astnode) = 
  match n with
  | AndNode (l, r) -> (eval_node l) && (eval_node r)
  | OrNode (l, r) -> (eval_node l) || (eval_node r)
  | NotNode l -> not (eval_node l)
  | IdNode v -> v

eval_node (AndNode (IdNode true, IdNode false)) (* returns false *)
</code></pre>

<p>The idea of that program was to create a small language to evaluate boolean expressions. In OCaml, it's quite succinct&mdash;too succinct, in all honesty. That's it. Of course it doesn't include a parser, or a lexer, but that's the crux of it.
</p>

<p>Since that original post, I've posted about two other <q>language hacks</q> that I've attempted to create&mdash;both of which use <a href="http://www.python.org/dev/peps/pep-0343/">context managers</a> and the <code class="inline">with</code>-statement, <a href="http://sigusr2.net/2009/Oct/01/python-worlds.html">worlds</a> and <a href="http://sigusr2.net/2009/Mar/04/dispatching-with-with.html">dispatching urls (a la routes)</a>.</p>

<p>Basically, it occurred to me yesterday, that <code class="inline">with</code>'s <code class="inline">as</code> clause did destructuring of tuples, in the same way that the assignment statement does. That is to say:</p>

<pre><code class="python">a, b, c = 1, 2, 3</code></pre>

<p>Will correctly assign <code class="inline">a = 1</code>, <code class="inline">b = 2</code>, <code class="inline">c = 3</code>, in the same exact way that:</p>

<pre><code class="python">from contextlib import contextmanager
@contextmanager
def assign(*args):
    yield args

with assign(1, 2, 3) as (a, b, c,):
    pass
</code></pre>

<p>will assign <code class="inline">a = 1</code>, <code class="inline">b = 2</code>, <code class="inline">c = 3</code>.</p>

<p>I'll admit, that doesn't look very powerful by itself, but when you consider the possibilities, you might come up with something like I did:</p>

<pre><code class="python">with structural_matching((1, 2, 3)) as match:
    with match('list() x y z') as (x, y, z):
        print x, y, z
    with match('tuple() x _ z') as (x, z):
        print "tuple case"
        print x, z
</code></pre>

<p>which looks incredibly close to pattern matching in OCaml. I was super excited&mdash;but it won't work.</p>

<p>See, <code class="inline">match</code> is a context manager that gets returned with the intention that if the <code class="inline">__enter__()</code> method raises a <code class="inline">NoMatch</code> exception, it skips the "body" and goes to the next match. The problem with that thinking however is simple&mdash;there's no way for <code class="inline">__enter__</code> to force skipping the body due to rejected <a href="http://www.python.org/dev/peps/pep-0377/">PEP-377</a>!</p>

<p>In the example above (full source <a href="http://files.sigusr2.net/match1.py">here</a>), raising <code class="inline">NoMatch</code> in the first <code class="inline">match</code> block, results in control being passed back to the <code class="inline">__exit__()</code> of the outer context manager&mdash;<code class="inline">structural_matching</code>. And to think, I got my hopes up!</p>

<p>But nevertheless, I pressed on, and hacked <a href="http://files.sigusr2.net/match2.py">together</a>, a <code class="inline">match</code>, that can destructure the following examples correctly:</p>

<pre><code class="python">with match('[1:3]', [1, 2, 3, 4]) as (a,):
    print a
# [2, 3]

with match('[1:]', "hello world") as (a,):
    print a
# ('e', 'ello world')

with match('str() x y', 'hello world') as (h, e):
    print 'h = ', h, ',',
    print 'e = ', e
# h = h, e = e

with match('x y z', [1, 2, 3]) as (x, y, z,):
    print z, y, x
# 3 2 1

class obj(object):
    def __init__(self, x, y):
        self.x = x
        self.y = y

with match('obj() .x .y', obj('x-ity', 'y-ity')) as (x, y):
    print 'x = ', x, ',',
    print 'y = ', y
# x = x-ity, y = y-ity

with match('x y _', [1, 2, 3]) as (x, y):
    print x, y
# 1, 2
</code></pre>

<p>It's much less useful considering you can't put it in the <code class="inline">structural_match</code> block ,like you would in a <em>real</em> <code class="inline">match</code> statement, but it's all we've got.</p>

<p>Back then, I concluded with <q>This is as close to OCaml like  pattern matching that we're going to get, at least as far as I know how to get, but it's sort of cool, and definitely a hack.</q> Today, I'll conclude the same way.</p>


<h5 class="tag-list">Tagged: 
  <a href="/tags/python.html">python</a>
     , <a href="/tags/with.html">with</a>
     , <a href="/tags/hack.html">hack</a>
     , <a href="/tags/ocaml.html">ocaml</a>
     
</h5>

<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/sigusr2/embed.js"></script><noscript><a href="http://sigusr2.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
      <div id="sidebar">
        <h2>About</h2>
        <p>
          Hi, I'm <a href="http://apgwoz.com" title="My Homepage">Andrew</a>. I sometimes use this space to write about things I'm doing related to programming.
        </p>
        <p>
          You should follow me on <a href="http://twitter.com/apgwoz">Twitter</a>.
        </p>
	<h2>Inside</h2>
	<ul>
          <li><a href="/page/man.html" title="man page for signal(7)">man signal(7)</a></li>
	</ul>

        <h2>Syndicate</h2>
        <ul>
          <li><a href="/atom.xml" title="Atom Feed">Atom</a></li>
        </ul>
        <h2>Archives</h2>
        <ul>
        
        <li><a href="/2011/Aug/" title="August 2011 (1)">August 2011 (1)</a></li>
        
        <li><a href="/2011/Apr/" title="April 2011 (1)">April 2011 (1)</a></li>
        
        <li><a href="/2011/Jan/" title="January 2011 (1)">January 2011 (1)</a></li>
        
        <li><a href="/2010/Nov/" title="November 2010 (1)">November 2010 (1)</a></li>
        
        <li><a href="/2010/Oct/" title="October 2010 (3)">October 2010 (3)</a></li>
        
        <li><a href="/2010/Jun/" title="June 2010 (3)">June 2010 (3)</a></li>
        
        <li><a href="/2010/Apr/" title="April 2010 (1)">April 2010 (1)</a></li>
        
        <li><a href="/2010/Jan/" title="January 2010 (1)">January 2010 (1)</a></li>
        
        <li><a href="/2009/Nov/" title="November 2009 (1)">November 2009 (1)</a></li>
        
        <li><a href="/2009/Oct/" title="October 2009 (1)">October 2009 (1)</a></li>
        
        <li><a href="/2009/Sep/" title="September 2009 (1)">September 2009 (1)</a></li>
        
        <li><a href="/2009/Jul/" title="July 2009 (1)">July 2009 (1)</a></li>
        
        <li><a href="/2009/May/" title="May 2009 (1)">May 2009 (1)</a></li>
        
        <li><a href="/2009/Apr/" title="April 2009 (1)">April 2009 (1)</a></li>
        
        <li><a href="/2009/Mar/" title="March 2009 (1)">March 2009 (1)</a></li>
        
        <li><a href="/2009/Feb/" title="February 2009 (1)">February 2009 (1)</a></li>
        
        <li><a href="/2009/Jan/" title="January 2009 (1)">January 2009 (1)</a></li>
        
        <li><a href="/2008/Dec/" title="December 2008 (1)">December 2008 (1)</a></li>
        
        <li><a href="/2008/Sep/" title="September 2008 (3)">September 2008 (3)</a></li>
        
        </ul>
      </div>
    </div>

    <div id="footer">
       &copy; 2009 <a href="http://apgwoz.com/">Andrew Gwozdziewycz</a>, I like bees. Powered by Modest. Not tested in IE, because it sucks.
    </div>
  </div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-354660-9");
pageTracker._trackPageview();
</script>
</body>
</html>