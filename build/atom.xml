<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title>SIGUSR2</title><link href="http://sigusr2.net/atom.xml" rel="self" /><link href="http://sigusr2.net/"/><updated>2009-05-07T19:22:37Z</updated><author><name>Andrew Gwozdziewycz</name></author><id>md5:ec2c8804a8dac6a866e1a43cfce32fc1</id><entry><title>The Hacker's Utility Belt: SSH</title><link href="/2009/May/07/hacker-utility-belt-ssh.html"/><id>md5:1c30eb53e322a859bb17913f525bd6ef</id><updated>2009-05-07T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">Most hackers<a href="#f1">[1]</a> aren't <a href="http://en.wikipedia.org/wiki/Batman">Batman</a>, but aside from <a href="http://en.wikipedia.org/wiki/Batman%27s_utility_belt">Batman's utility belt</a>, the Batcave and Alfred, he's no different than you and me.</span></p>

<p>He's got strength and training on his side, but I could probably take him if he didn't have his belt and was blindfolded. Give him his utility belt though, and I'd be doomed. That's not because his belt has super powers&mdash;instead his belt contains tools that are useful in common situations of distress, and of course detective work. The Bat-grappling hook for instance allows him to scale buildings and walls, and tranquillizer darts allow him to temporarily disable a foe. Batarangs, with practice, can be used to disable an opponent by aiming for a body part, or to cut down a hanging chandelier, creating yet another obstacle for foes to fight through.</p>

<p>Hackers have similar tools, but we carry them in "/usr/bin/" (though how cool would it have been if the <a href="http://en.wikipedia.org/wiki/Unix">Bell Labs folks</a> named it "/usr/belt/" instead). The tools <em>we</em> use, generally allow us to solve problems quickly and efficiently&mdash;just like Batman.</p>

<p>The tool that I've come to rely on quite a bit recently is <a href="http://en.wikipedia.org/wiki/Secure_Shell">SSH</a>. Most hackers use SSH for working remotely on servers, and for copying files over <a href="http://en.wikipedia.org/wiki/Secure_copy">SCP</a> or <a href="http://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol">SFTP</a>. Some may even use <a href="http://en.wikipedia.org/wiki/Filesystem_in_Userspace">FUSE</a> and <a href="http://en.wikipedia.org/wiki/SSHFS">SSHFS</a> to mount file systems over SSH. Its potential uses are endless, but the most useful uses for me lately have been tunneling and <a href="http://en.wikipedia.org/wiki/SOCKS">SOCKS</a> proxies.</p>

<h3>Tunneling</h3>
<p>As a programmer who on occasion works from home (more so currently), it's often a battle to connect to all of the company resources I need in order to perform my job. Firewalls are good things, and are configurable to allow remote people access to walled gardens, but with dynamic <a href="http://en.wikipedia.org/wiki/IP_address" title="Internet Protocol Address">IP addresses</a> being the common norm, opening up resources to many different addresses gets hard for sysadmins to track. Besides, they've got a ton on their plate already.</p>

<p>To combat this problem, <a href="http://en.wikipedia.org/wiki/VPN" title="Virtual Private Network">VPN</a>s were created. Basically, a VPN allows one to connect networks together as if they were local to each other. When I use my companies VPN, it's as if I'm sitting in the office.</p>

<p>Often though, this isn't enough. When dealing with networks that clients own, they may provide us access through only one entry point, a single development server for instance, which is locked down.</p>

<p>This is where SSH comes in handy. In the <a href="http://www.openssh.com/">OpenSSH</a> implementation of the SSH client tools, the <code class="inline">-L</code> option allows one to setup forwarding of traffic to another host. Suppose, I wanted to connect to a client's Oracle server, listening on port 1521:</p>

<code>$ ssh -N -L 9999:clients.oracle.server.name:1521 user@your.companies.host
</code>

<p>Now instead of pointing our SQL*Plus client to <em>clients.oracle.server.name</em>:1521, we point it to localhost:9999, and traffic is forwarded via <em>your.companies.host</em> as if we were connecting directly from <em>your.companies.host</em>.
</p>

<p>This is extremely powerful, and simple.<a href="#f2">[2]</a></p>

<h3>SOCKS Proxy</h3>

<p>Similar to the tunnelling example above, OpenSSH can act like a <a href="http://en.wikipedia.org/wiki/SOCKS">SOCKS</a> proxy, allowing you to forward outbound traffic to a trusted source, which will then carry out the request on your behalf. This is <em>great</em> for browsing in public <a href="http://en.wikipedia.org/wiki/Wi-Fi" title="Wireless Fidelity">WI-FI</a> spots where attackers might be sniffing for passwords being sent in plain text over HTTP, or some other unencrypted protocol.<a href="#f3">[3]</a></p>

<p>And, of course, setting it up is as easy as passing the <code class="inline">-D</code> option to ssh when connecting to you@remoteserver.</p>

<code>$ ssh -N -D 8000 user@remoteserver</code>

<p>Then, you can setup your computer (or web browser) to use a SOCKS proxy, and point it to localhost:8000.</p>

<p>This isn't without its problems though. For one, the network could block all outbound traffic except HTTP/HTTPS. One obvious workaround is to have a remote server listening for SSH connections on port 143 or port 80, instead of the protocol default of 22. But, you'll of course need your own box, or <a href="http://en.wikipedia.org/Virtual_private_server" title="Virtual Private Server">VPS</a> for this, as your shared hosting account will probably not allow you to change sshd's listening port.<a href="#f4">[4]</a></p>

<p>Of course, since SSH is a protocol for sending encrypted network traffic, there are <a href="http://www.ssh.com/support/documentation/online/ssh/adminguide/32/X11_Forwarding.html">many</a> <a href="http://unixwiz.net/techtips/ssh-agent-forwarding.html">other</a> uses for it. These are just the two alternatives I find the most useful lately.</p>

<ol class="footnotes">
<li id="f1">
I use the <a href="http://www.ccil.org/jargon/jargon_23.html#TAG833">jargon file's</a> definition of hacker, not the commonly confused term <a href="http://www.ccil.org/jargon/jargon_18.html#TAG365">cracker</a>.
</li>

<li id="f2">
It can of course get much, much more complicated
</li>

<li id="f3">
Unencrypted WIFI traffic is extremely easy to capture, with a tool like <a href="http://www.tcpdump.org">tcpdump</a>
</li>

<li id="f4">
The thought of a "loopback" SOCKS proxy, "loopback" tunnel or some combination of the two cannot work, as it would only ever forward traffic to your localhost's sshd, which would then forward traffic to the destination, unencrypted, over the local network&mdash;this is the exact situation we were trying to avoid. Plus, if you're trying to forward traffic in this way, over a port that's being blocked, it's still blocked.
</li>
</ol>
]]></content></entry>
<entry><title>The Power That is GNU Emacs</title><link href="/2009/Apr/30/the-power-that-is-gnu-emacs.html"/><id>md5:5956c986d4c2f11dbf3231b781690d06</id><updated>2009-04-30T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">If you've never been convinced before that <a href="http://www.gnu.org/software/emacs">Emacs</a> is the text editor in which dreams are made from, or that inside Emacs there are unicorns manipulating your text, don't expect me to convince you. 
</span></p>

<p>I'm not going to sit here and type out a Top 10 list of reasons <em>you</em> should be using GNU Emacs, nor am I going to tell you that you are an idiot for using VI (I was a hardcore, "down with emacs," VI user in the late 90s and early 00s). Instead, I'm going to talk about why Emacs works for <em>me</em>. If you're so inclined to give it a try after reading this, then so be it. Searching <a href="http://www.google.com/search?q=emacs+tutorial" title="Google Search Query for 'emacs tutorial'">Google</a> is bound to get you a ton of good information, or you could just start Emacs by typing <code class="inline">emacs</code> at the terminal and typing <code class="inline">C-h</code> (<code class="inline">C-</code> means hold down the control key and hit <code class="inline">h</code> [in this case]. <code class="inline">M-<em>key</em></code> means hold down the Meta key [ALT on most keyboards] and hit <code class="inline"><em>key</em></code>. If there's not a <code class="inline">-</code> between them, you can release Control or Meta before hitting the <em>key</em>).</p>

<p>I first started using Emacs in the spring of 2003, when an acquaintance at the time suggested that Emacs was superior and that I could even use <a href="http://www.emacswiki.org/emacs/ViperMode" title="Viper Mode - VI keybindings for Emacs">viper-mode</a> to simulate VI. The idea that a text editor was powerful enough to simulate another caught my curiosity. I fired it up, and hit the backspace key. Within moments I was put off when the Emacs equivalent of <a href="http://en.wikipedia.org/wiki/Clippy">Clippy</a>, came to my rescue.</p>

<p>See, Emacs responds logically to <code class="inline">C-h</code>, with "Help." The problem is that on many modern keyboards, the backspace key and <code class="inline">C-h</code> send the same value to the terminal.</p>

<p>So, I fired up <a href="http://www.getfirefox.com">Phoenix</a> (or was it Firebird then? Maybe it was Fireweasel?) and searched Google for "emacs backspace problem." Within .004 seconds I had over 3 million pages telling me how to fix the problem. It said to add:</p>

<code class="lisp">(global-set-key "\C-h" 'delete-backward-char)</code>

<p>to my ~/.emacs file. So, I went to my terminal and did what anyone would have done in my situation&mdash;I typed <code class="inline">vi ~/.emacs</code>, pasted the snippet and <code class="inline">ESC :wq!</code>'d</p>

<p>But, despite my trouble I was intrigued. First of all, I had never seen a Unix program configured the way it was. Why didn't Emacs just use something like <a href="http://en.wikipedia.org/wiki/INI_file">INI</a> files, or some other simple format? Later, I realized that I wasn't just configuring Emacs&mdash;no, I was <em>programming</em> the editor to behave the way <em>I</em> preferred.</p>

<p>And, you'll say, "Well, how is that any different than configuration?" To, which I'll reply, "Every command you invoke, even the command that inserts the letter 'j' into this quote here, is calling a function written in the language I used before to set <code class="inline">C-h</code> to behave the way I preferred."</p>

<p>You see, Emacs isn't a text editor. Emacs is a programming language that you can use to write your <em>own</em> text editor. That's why <code class="inline">viper-mode</code> exists. Someone used Emacs to write VI.</p>

<p>And, as I read more about Emacs, and about all the editors people have written (that is to say, editors for writing C, Perl, Python, etc), I got more excited; that is until I discovered <code class="inline">M-x tetris</code>. Why does my editor need <a href="http://en.wikipedia.org/wiki/Tetris">Tetris</a>? It doesn't, and when I discovered more games, I got even more disgusted.</p>

<p>I'm not going to lie&mdash;not even a little bit, in 2003, Emacs was slow. Machines were getting faster, <a href="http://en.wikipedia.org/wiki/RAM">RAM</a> like always was cheap, but it was torture to type <code class="inline">emacs <em>filename</em></code> more than once a day. The games, and all this bloat were obviously the cause right? Well no. It turns out that Emacs has smart ways to load code, so you can save your precious memory. As a naive user, though, I was a bit upset.</p>

<p>So, off to Google again. "Google, How do I speed up Emacs?" "Well, my young Padawan," Google replied, "you should use the server. Add <code class="inline">(server-start)</code> (<code class="inline">M-x describe-function RET server-start RET</code> if you want more info) to your <code class="inline">~/.emacs</code> file and connect with <code class="inline">emacsclient</code>." This was a few days later, and I had a cheat sheet on my desk, so I didn't escape to the terminal and start up VI. This time, I knew to chord <code class="inline">C-x C-f</code>, make my changes and chord <code class="inline">C-x C-s</code>. Easy-peasy.</p>

<p>The common theme here is that documentation for Emacs was easily accessible and there was a seemingly endless community of people answering questions about common pitfalls when getting started with Emacs. As a newbie, this fact made it extremely easy to want to continue learning, and as an advanced user today (can one ever gain the rank of Emacs expert?) this fact still draws me in.</p>

<p>Emacs has since gotten faster as a result of extremely cheap processing power, but VI of course still wins in startup time. It's not a very good metric for comparing the two pieces of software though. For one, I mentioned that Emacs had a server that you could use to keep Emacs going and connect with <code class="inline">emacsclient</code>, but I should also mention that I hardly ever use it. Emacs has an extensive file browser (with tab-completion!), and support for editing multiple files (called buffers). The other thing Emacs has is a mode called <a href="http://www.gnu.org/software/tramp/">Tramp</a>, which allows Emacs to edit files over <a href="http://www.openssh.com/" title="Secure SHell">SSH</a>, <a href="http://en.wikipedia.org/wiki/FTP" title="File Transfer Protocol">FTP</a> and many more. Since this is the case, keeping one Emacs session alive forever makes startup time nil. VI, on the other hand encourages relaunching with new files. I'm fairly sure modern VIs support editing more than one file at once, but I'm also pretty convinced that most VI users know about 15 things about VI, and multiple file editing isn't one of them.</p>

<p>The reason I even still have <code class="inline lisp">(server-start)</code> in my <code class="inline">~/.emacs</code> has to do with other utilities that need an editor. Invoking <code class="inline">emacsclient <em>filename</em></code> will open <code class="inline"><em>filename</em></code> in the Emacs instance that the server is running in. No startup lag&mdash;but you do unfortunately have to context switch.</p>

<p>Naturally, the Emacs community has solved this problem of context switch for many common cases. One of the places where you're bound to need to startup an editor as a programmer is when interacting with <a href="http://en.wikipedia.org/wiki/Software_configuration_management" title="Source Control Management">SCM</a> tools such as <a href="http://subversion.tigris.org/">Subversion</a>, <a href="http://www.selenic.com/mercurial/wiki/">Mercurial</a> or <a href="http://git-scm.com/">Git</a>. These tools allow you to leave messages when you commit changes back to the repository. Committing is common, as is updating files and working with version control repositories in general, so it's only natural that your editor be version control aware. Emacs is, and uses <a href="http://www.emacswiki.org/emacs/VersionControl"><code class="inline">vc-mode</code></a>.</p>

<p>And the more you think about interactions with computers the more you realize how much of it is still text based. <a href="http://en.wikipedia.org/wiki/IRC">IRC</a>, for instance is entirely text based, so why make it hard on yourself to switch back and forth between running programs when you can switch to an IRC buffer in Emacs? I do that, and it's wonderful.</p>

<p>Todo lists, calendars, calculators, Emacs does it all. It's no wonder that mere mortals joke about Emacs, saying "I'm happy with my operating system, I just want a decent text editor!" I said the same thing, and once I tried it, and took the time to learn it, I could never go back.</p>

<h3>Extending</h3>
<p>Over the years, I've discovered lots of things about Emacs, and new modes to play with. There's a never ending list of things to play with on <a href="http://www.emacswiki.org">EmacsWiki</a> if you're so inclined.
</p>

<p>As a programmer, writing my own enhancements was a matter of learning a bit about <a href="http://en.wikipedia.org/wiki/Emacs_lisp">Emacs Lisp</a>, the <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a> dialect that Emacs is built on. Coming from a background in C, Perl and at this point in time Python, I laughed at Lisp. "Why would anyone want to write that many parenthesis?" I've since come to the conclusion that Lisp is the most powerful set of programming languages available, but that is a topic for another day. (It is no coincidence, however that the most powerful text editor is built upon a dialect of the most powerful programming language.)</p>

<p>One of the first things I extended Emacs with was a way to convert Windows text files, which use carriage return and a line feed to something more appropriate for editing on Unix (line feed only). I came up with this with some help from our friend Google:</p>

<code class="lisp">(defun dos2unix ()
  "Convert this entire buffer from MS-DOS text file format to UNIX."
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (replace-regexp "\r$" "" nil)
    (goto-char (1- (point-max)))
    (if (looking-at "\C-z")
        (delete-char 1))))
</code>

<p>I'm fairly certain that I didn't write that completely from scratch, and I know for certain that I lifted the <code class="inline">(if (looking-at...) ...)</code> from the Internet somewhere as I'm not even sure why I would want to delete <code class="inline">C-z</code> characters from the end of the file.</p>

<p>Either way, the point is the same, now, without a context switch to the terminal, and the need to have the dos2unix package installed on my system, I can open a Windows text file and say, <code class="inline">M-x dos2unix</code>, and I'm in business.</p>

<p>Another utility that I decided I needed was the ability to split the current window in a 3/4, 1/4 configuration, instead of the default 1/2, 1/2 that you get when you call <code class="inline">split-window</code>. The result looks something like this:</p>

<code class="lisp">(defun three-quarters-window ()
  "Resizes current window big"
  (interactive)
  (let ((size (- (truncate (* .75 (frame-height))) (window-height))))
    (if (> size 0)
        (enlarge-window size))))
</code>

<p>Bound to a key, <code class="inline">(global-set-key "\C-x7" 'three-quarters-window)</code>, makes it easy to keep an eye on an IRC buffer or something else that's changing a few lines at a time, while remaining relatively focused on the buffer you're really editing.</p>

<p>As I continue to try out new major modes and spend time programming Emacs to behave the way I want it to, it's only natural that my <code class="inline">~/.emacs</code> file has become a bit large and hard to read. So I built something to fix it. I built something that allowed me to separate customizations into logical units. Basically, it works similarly to the <a href="http://en.wikipedia.org/wiki/Init">init</a> process from Unix.</p>

<p>I call my version activator. It's basically a few functions and a few overridable variables that will load a set of files with a specifically formatted file name in some specific location on your file system.</p>

<p>Using it is as simple as including a few lines in your <code class="inline">~/.emacs</code> file:</p>

<code>;;;; Need to tell Emacs which directory has activator.el
(setq load-path (cons <em>path to directory containing activator.el</em> load-path))
(require 'activator)
(activator-start)
</code>

<p>By default activator will look for files in <code class="inline">~/.emacs.d/activator.d/</code> with the file name format <code class="inline"><em>XX</em>description.el</code>, where <em>XX</em> is a two digit number used for dependency resolution. In other words, <code class="inline">00settings.el</code> will be loaded before <code class="inline">01utils.el</code> if you were to have those files in your activator load path.</p>

<p>The code for doing this is surprisingly simple:</p>

<code class="lisp">(defun activator-start ()
  "Starts activator, thereby running all the files in `activator-load-path' 
that match the `activator-filename-pattern`"
  (interactive)
  (if (not (boundp 'activator-load-path))
      (error "Please set `activator-load-path`")
    (mapcar 'activator-load-file (activator-get-files))))

(defun activator-get-files (&optional path pattern)
  "Gets files from path specified by `activator-load-path', or from the 
optional path"
  (let ((path (or path activator-load-path))
        (pattern (or pattern activator-filename-pattern)))
    (directory-files path t pattern)))

(defun activator-load-file (file)
  (load-file file))
</code>

<p>Of course, the <a href="http://gitorious.com/projects/emacs-configuration/repos/mainline/blobs/master/activator.el">real code</a> defines the variables <code class="inline">activator-filename-pattern</code> and <code class="inline">activator-load-path</code>, which must be overridden before <code class="inline">(activator-start)</code> is run, should you decide you want to change them.</p>

<p>But, the real power in this is that I can rename configuration files to something that doesn't match the filename pattern if I don't want them to load, say because my configuration needs to be different at work, rather than at home. This makes my Emacs customizations pretty portable, and with a few more tweaks to the way activator works, I could make it even more portable.</p>

<p>I'm not going to be naive and think that I'm the first one to come up with something like this. I know for sure I'm not, and the only reason I did it myself was for the exercise of writing Emacs Lisp. All my customizations to Emacs are loaded currently with activator on all the machines that I use Emacs on. It's pretty great.</p>

<p>As a programmer who spends many hours a day using a text editor, the companionship that Emacs provides is a joy, and our relationship just keeps growing better as I uncover the stories and talents, my little friend has to share. </p>
]]></content></entry>
<entry><title>Dispatching With "with"</title><link href="/2009/Mar/04/dispatching-with-with.html"/><id>md5:c47b741e6d7072c9b14a6d5f74c671f1</id><updated>2009-03-04T08:15:00Z</updated><content type="html"><![CDATA[<p>
<span class="preamble">Since <a href="http://www.python.org">Python</a> 2.5, we've had access to a new contstruct called the <a href="http://www.python.org/dev/peps/pep-0343/"><code class="inline">with</code></a>-statement. Using them is as simple as implementing the <a href="http://www.python.org/doc/2.5.2/lib/typecontextmanager.html">context manager protocol</a> for classes.
</span>
</p>

<p>The <code class="inline">with</code>-statement makes it possible to factor our <code class="inline">try</code>/<code class="inline">finally</code> statements that are commonly used to clean up resources created temporarily. Suppose for example, you have a multi-threaded application that makes use of mutexes to guard shared information. As a general rule, once you lock and perform the update on the shared variable, you need to unlock. Failure to unlock can lead to horrible problems, such as starvation or some other inconsistent state. 
</p>

<p>And, what happens if an exception occurs before you unlock? Quite frankly, you're out of luck unless you use <code class="inline">try</code>/<code class="inline">finally</code> to clean up regardless of what happens. It might look something like this:</p>

<code class="python">lock.lock()
try:
    # perform some action
finally:
    lock.unlock()
</code>

<p>This ensures that <code class="inline">lock</code> is unlocked after the action is performed.</p>

<p>Now, using the <code class="inline">with</code>-statement we get something more like:</p>
<code class="python">with lock:
    # perform some action
</code>

<p>The beauty is that we don't have to worry about remembering to call <code class="inline">unlock</code>, or wrap it up in the <code class="inline">try</code>/<code class="inline">finally</code> block. It does it for us.</p>

<p>But, we're not worried about locks here. We're interested in using <code class="inline">with</code> for another purpose, dispatching based on a requested url.</p>

<h3>URL Dispatching</h3>

<p>In many web frameworks these days for Python, such as <a href="http://webpy.org">web.py</a>, resources are dispatched to based on a regular expression that gets matched against the REQUEST_URI environment variable. This is normally pretty powerful, but in the case of web.py, the way this is specified is often a bit awkward. Take for instance:
</p>

<code class="python">import web

urls = (
    '/([a-zA-Z]*)', 'Hello'
)
app = web.application(urls, globals())

class Hello:
    def GET(self, name):
        if not name:
            name = 'world'
        return "Hello,", name

    def POST(self, name): # name can still be in the url
        i = web.input(name='world')
        return "You posted your name! Hello,", i.name

if __name__ == '__main__':
    app.run()
</code>

<p>which is a whole web application written in web.py. The awkwardness comes from the fact that the regular expression used for dispatch, is in no way connected to the resource itself. It'd be nice to use decorators for this so you could get something like:</p>

<code class="python">@web.expose('/([a-zA-Z]*)')
class Hello:
    ...
</code>

<p>but Python didn't get class decorators til Python 3.0, which many people aren't using yet, the author included. And what's the logic behind <code class="inline">def GET(<strong>self</strong>, ...)</code>? It's required in Python, but is just extraneous when defining a resource for web.py.</p>

<p>What if we implemented the context manager protocol in the object returned by <code class="inline">web.application()</code> above that looked like this (or something similiar):
</p>

<code class="python">import inspect
    --snip--
    def __enter__(self):
        return self

    def __exit__(self, *args):
        frame = inspect.currentframe()
        get = frame.f_back.f_locals.get('get', None)
        post = frame.f_back.f_locals.get('post', None)
        resource = {}
        if get:
            resource['get'] = get
        if post:
            resource['post'] = post

        if not (post or get):
            raise ValueError("with must have a get or post function")
        self._resources.append((re.compile(self._last_url), resource))

        if get:
            del frame.f_back.f_locals['get']
        if post:
            del frame.f_back.f_locals['post']

    def expose(self, url):
        self._last_url = url
        return self

    ...
</code>

<p>Then, the simple hello application instead looks like:</p>

<code class="python">import web

app = web.application()

with app.expose('/([a-zA-Z]*)'):
    def get(name):
        if not name:
            name = 'world'
        return "Hello,", name

    def post(name):
        i = web.input(name='world')
        return "You posted your name! Hello,", i.name

if __name__ == '__main__':
    app.run()
</code>

<p>It's declarative, simple, and eliminates a lot of noise, but we no longer get the packaging, or the ability to easily seperate our resources into multiple files. But, for one file web apps, maybe it's useful.</p>
]]></content></entry>
<entry><title>Higher Order PHP</title><link href="/2009/Feb/06/higher-order-php.html"/><id>md5:513adfddef8cc627680095e91c28d467</id><updated>2009-02-06T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">There's no doubt in my mind that <a href="http://en.wikipedia.org/wiki/Higher_order_programming">Higher order programming</a> is value added to a programmers toolbox, and with the pending release of PHP 5.3, it's about to become much more mainstream.</span></p>

<p><a href="http://www.php.net">PHP</a>, as it stands currently (pre 5.3), already has some support for higher-order programming by passing around the names of functions as strings. It also supports so-called <a href="http://en.wikipedia.org/wiki/Anonymous_functions">anonymous functions</a>, via the <a href="http://www.php.net/create_function"><code class="inline">create_function</code></a> function, though PHP does give those functions a name (something like "<code class="inline">lambda_N</code>"). 
</p>

<p>Functions created in this way, or created in the "normal" PHP way, can then be used in library functions such as <a href="http://www.php.net/array_map"><code class="inline">array_map</code></a>, <a href="http://www.php.net/array_reduce"><code class="inline">array_reduce</code></a> and <a href="http://www.php.net/array_filter"><code class="inline">array_filter</code></a>. These are extremely useful for performing some action on each element of the array passed as an argument, but it seems rare that PHP programmers actually use them in practice.</p>

<p>It may be the case that most PHP programmers don't know about these functions, or it could be the case that these functions are extremely awkward to use currently due to the requirement of having already created the function elsewhere.</p>

<p>See, in nearly every major language that supports higher-order programming, a concept of <a href="http://en.wikipedia.org/wiki/Lexical_closure">closure</a> comes into play. This is extremely useful when creating functions one off anonymous functions to pass around. Basically, when a function is defined within some lexical scope, variables that are "<a href="http://en.wikipedia.org/wiki/Free_variable">free</a>" in that function must be "<a href="http://en.wikipedia.org/wiki/Bound_variable">bound</a>" in an enclosing <a href="http://en.wikipedia.org/wiki/Scope_(programming)">environment</a>, or when one uses a variable it will be undefined, causing an error. The solution is simply to keep a reference to the enclosing environment when the function is created.</p>

<code class="scheme">
(define (make-counter starting) 
   (lambda (increment) ;;; the variable `starting` occurs "free" in this function
      (set! starting (+ starting increment))
      starting))

(define count (make-counter 0))
(define count2 (make-counter 3))

(count 1) ;;; sets starting in the closure 'count' to 1 and returns it
(count2 5) ;;; sets starting in the closure 'count2' to 8 and returns it
(count 3) ;;; sets starting in the closure 'count' to 4 and returns it
</code>

<p>In the example above, <code class="inline">count</code> and <code class="inline">count2</code> both refer to different starting values. <code class="inline">make-counter</code> "closed" over the environment each time it was called and produced closures. <code class="inline">make-counter</code> has the effect of being a function factory that stamps a starting value on the function returned.</p>

<p>So, until the alpha release of PHP 5.3, it was impossible to create a function that referred to it's enclosing environment without lots of hackery. PHP 5.3, makes it possible, but in a slightly awkward way.
</p>

<code class="php">
function make_counter($starting) {
   return function ($increment) use (&$starting) {
      $starting += $increment;
      return $starting;
   };
}
</code>

<p>PHP doesn't allow you to keep a reference to the entire enclosing environment; instead you must explicitly state which variables you want to be able to refer to. Taking that one step further, you must decide whether or not you want that variable to be re-assignable and "pass by reference," if you do. I think it's a little clumsy, but the introduced <code class="inline">use</code> keyword at least makes these things a little bit self-documenting.</p>

<code class="php">
$cnt = make_counter(5);
$cnt2 = make_counter(15);

echo $cnt(5) . " == 10?\n"; // outputs: 10 == 10?
echo $cnt2(-15) . " == 0?\n"; // 0 == 0?
echo $cnt2(5) . " == 5?\n"; // 5 == 5?
</code>

<p>As you can see, it does pretty much the same thing as was done in the Scheme example above.</p>

<p>So now it's time to exploit it.</p>

<h3>Introducing Fn.php</h3>

<p>Throughout the history of <a href="http://en.wikipedia.org/wiki/Functional_programming">functional programming</a>, programmers (and non programmers alike), have identified many useful functions for performing operations. These include the functions above such as <code class="inline">array_map</code>, <code class="inline">array_reduce</code> and <code class="inline">array_filter</code>, but also things like <a href="http://en.wikipedia.org/wiki/Currying"><code class="inline">curry</code></a>, which given a function <code class="inline">g</code> and an argument <code class="inline">a</code>, returns a function that promises to call the function <code class="inline">g</code> with the argument <code class="inline">a</code> plus whatever arguments are passed to it. In effect, <code class="inline">curry</code>, delays the function call until more knowledge is known. (Incidently, the <code class="inline">make-counter</code> function uses currying.)</p>

<p><a href="http://hg.apgwoz.com/fn-php">Fn.php</a> is an attempt to define lots of useful higher-order functions to PHP, and fix some of the things that are inconsistent with the others. Fn.php already supports the things in PHP that already exist, but adds <code class="inline">foldr</code>, <code class="inline">compose</code>, <code class="inline">zip</code>, <code class="inline">andf</code>, <code class="inline">orf</code>, <code class="inline">not</code>, <code class="inline">any</code>, <code class="inline">every</code>, <code class="inline">curry</code>, <code class="inline">I</code>, <code class="inline">K</code>, <code class="inline">S</code>, <code class="inline">flip</code> and a new short hand way to define functions with strings.</p>

<p>
There's virtually no documentation, and very little in the way of examples or tests. It was started on a whim yesterday when I woke up, so we'll see where it goes.
</p>
]]></content></entry>
<entry><title>Anagrams Predicate</title><link href="/2009/Jan/08/anagrams-predicate.html"/><id>md5:c7c123380fbc5a9934d6d485b0a050aa</id><updated>2009-01-08T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">Recently, I spent some time thinking about a simple problem. How do you test if two strings are <a href="http://en.wikipedia.org/wiki/Anagram">anagrams</a> of each other?</span></p>

<p>There are many ways, but the naive solution is to simply sort both strings, character-wise, and then compare the results. In <a href="http://www.python.org">Python</a>, you might do that like so (We'll leave out the fact that anagrams are actually real words and phrases. We also work in a case-sensitive manor [e.g. "JimMorrison" and "MrMojoRisin" isn't truthy, though a simple <code class="inline">s.lower()</code> goes a long way.]):</p>

<code class="python">def isAnagram(str1, str2):
    if len(str1) != len(str2): return False
    return sorted(str1) == sorted(str2)
</code>

<p>Here, I'm using <code class="inline">sorted</code>, a Python <code class="inline">__builtin__</code>, that takes an iterable and produces a sorted list of that iterable. I'm then taking advantage of the fact that Python lists can be compared element-wise with the <code class="inline">==</code> operator. Doing this produces a function that will work on any string, and it's simple to see why. Sort the string "parental" and you get "aaelnprt." Sort the string "paternal" and you still get "aaelnprt." Obviously "aaelnprt" and "aaelnprt" are equivalent. This of course returns <code class="inline">False</code> for the strings "snowman" and "iceman" since they don't compare sorted equally (or non-sorted for that matter).</p>

<p>However, this solution isn't the most efficient use of resources. For one, most sorting algorithms are only <em>O(n log n)</em>, which means in the best case <code class="inline">isAnagram</code> is too. It also needs to allocate two lists to store the results returned by <code class="inline">sorted</code>.</p>

<p>There is of course a way to do better. You just have to think about the problem for a little longer than a minute:</p>

<code class="python">def isAnagramN(str1, str2):
    if len(str1) != len(str2): return False
    counts = defaultdict(lambda: [0, 0])

    for c1, c2 in izip(str1, str2):
        counts[c1][0] += 1
        counts[c2][1] += 1

    for k, v in counts.iteritems():
        if v[0] != v[1]:
            return False
    return True
</code>

<p>This code does not allocate proportionally to the size of the strings, but instead on the diversity of the strings. In other words, <code class="inline">isAnagramN("aaaaaaa", "bbbbbbb")</code> allocates 1 defaultdict, and 2 lists of size 2. Why? Because, the algorithm simply counts up how many times each letter occurs in each string. Of course Python also has to allocate the generators to use for <code class="inline">izip</code> and <code class="inline">counts.iteritems()</code>, but that isn't significant. The big win here of course is that given strings of <em>any</em> length, the algorithm uses only as much space as the diversity of the contents contained in the strings!</p>

<p>As if that wasn't a win enough, this algorithm runs in <em>O(n)</em> on the length of the strings!</p>

<p>But, does it actually make a difference? The answer of course is yes. For strings of significant length, <code class="inline">isAnagramN</code> runs almost 2x as fast as <code class="inline">isAnagram</code>.</p>

<p>The proof is in the bacon, so let's take a look at some numbers. Using Python's <code class="inline">timeit</code> module, I tested strings of length 1 through 100,001, incrementing by 10,000 (I've tested other lengths as well, and reach a similar conclusion). At each length, the test was repeated 50 times. The results are below:</p>

<style type="text/css">
td { text-align: right; }
td.win { background-color: #ADFF2F; font-weight: bold;}
td.first { background: #dddddd; font-weight: bold; color: #222222; }
</style>

<table cellspacing="5" style="margin: 0 auto;">
  <thead>
    <tr>
    <th>Length</th>
    <th>Time isAnagram</th>
    <th>Time isAnagramN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
     <td class="first">1</td><td class="win">0.00043511390686</td><td>0.000530958175659</td>
     </tr>
     <tr>
     <td class="first">10001</td><td>0.657309055328</td><td class="win">0.38395690918</td>
     </tr>
     <tr>
     <td class="first">20001</td><td>1.25437283516</td><td class="win">0.793761968613</td>
     </tr>
     <tr>
     <td class="first">30001</td><td>1.91431283951</td><td class="win">1.15374517441</td>
     </tr>
     <tr>
     <td class="first">40001</td><td>2.55181908607</td><td class="win">1.53560996056</td>
     </tr>
     <tr>
     <td class="first">50001</td><td>3.14615797997</td><td class="win">2.07976388931</td>
     </tr>
     <tr>
     <td class="first">60001</td><td>3.76745486259</td><td class="win">2.30041193962</td>
     </tr>
     <tr>
     <td class="first">70001</td><td>4.48913788795</td><td class="win">2.81828999519</td>
     </tr>
     <tr>
     <td class="first">80001</td><td>5.155148983</td><td class="win">3.09482097626</td>
     </tr>
     <tr>
     <td class="first">90001</td><td>5.67185592651</td><td class="win">3.477850914</td>
     </tr>
     <tr>
     <td class="first">100001</td><td>6.33614587784</td><td class="win">3.94285678864</td>
     </tr>
  </tbody>
</table>

<p>
  Download the code: <a href="http://files.sigusr2.net/anagram.py">anagram.py</a>
</p>
]]></content></entry>
<entry><title>Chocolate Cupcakes</title><link href="/2008/Dec/15/chocolate-cupcakes.html"/><id>md5:3410e6821ebb21b7c929fa42b3144244</id><updated>2008-12-15T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">Every now and then, I dust off my copy of <em><a href="http://www.amazon.com/gp/product/0262560992?ie=UTF8&tag=siusdesi2-20&linkCode=as2&camp=1789&creative=9325&creativeASIN=0262560992">The Little Schemer</a><img src="http://www.assoc-amazon.com/e/ir?t=siusdesi2-20&l=as2&o=1&a=0262560992" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></em> and read a few sections. It's a great book, in a unique and friendly format.</span></p>

<p>Part of the reason I pick up the book time and time again is because re-reading sections of it re-enforces the basic concepts that a Scheme programmer needs to know. Now I'm not saying I don't know these basic concepts, because I do, but my daily routine unfortunately does not involve Scheme. Instead, I spend my time not recursing on <code class="inline">cdr</code>s but using <a href="http://en.wikipedia.org/wiki/Imperative_programming" title="Imperative Programming">imperative</a> style looping constructs.</p>

<p>And, since I like to make my own junk food, it's the perfect book since it leaves pages for jelly stains and provides a chocolate chip cookie recipe. I thought it'd be nice to share my new favorite cupcake recipe, with peppermint icing&mdash;just in time for the holidays. I've stolen <a href="http://www.cs.indiana.edu/~dfried/">Friedman</a> and <a href="http://www.ccs.neu.edu/home/matthias/">Felleisen</a>'s recipe format:</p>

<pre><code class="scheme">
(define (chocolate-cupcakes)
  (bake '(375 degree) '(20 minute)
        (mix (mix '(sugar 1 cup)
                  '(flour 3/2 cup)
                  '(baking-soda 1 teaspoon)
                  '(cocoa 1/3 cup)
                  '(apple-sauce 1/2 cup)
                  '(cold-water 1 cup)
                  '(vanilla 2 teaspoon)
                  '(salt 1/2 teaspoon))
             '(vinegar 2 tablespoon))))

(define (peppermint-icing)
  (mix '(butter 1/2 cup)
       '(powdered-sugar 2 cup)
       '(vanilla 1 teaspoon)
       '(peppermint-extract 2 teaspoon)
       '(milk 3 tablespoon)))
</code></pre>

<p>Enjoy!</p>]]></content></entry>
<entry><title>Python Type Constructors a la OCaml</title><link href="/2008/Sep/30/python-type-constructors-like-ocaml.html"/><id>md5:5c9d3c4e3c5a50bf32b5481935fde949</id><updated>2008-09-30T07:00:00Z</updated><content type="html"><![CDATA[<p>
<span class="preamble">Earlier this summer, I started taking a look at the <a href="http://caml.inria.fr/" title="Objective-Caml">OCaml</a> programming language in anticipation of the compilers class I'm taking this fall.</span>
</p>

<p>OCaml is a strongly, <a href="http://en.wikipedia.org/wiki/Type_system#Static_typing">statically typed</a>, functional language with <a href="http://en.wikipedia.org/wiki/Type_inference">type inference</a>. It's pretty neat, and supports imperative programming as well as object-oriented constructs for when you need them. As a language, I've found few things wrong with it, except for the edit-compile-run cycle (I prefer the edit-run cycle you get in a language like Scheme, or even Python), but OCaml does actually have a toplevel (the toplevel isn't crippled either, but it doesn't seem realistic to not compile for testing, at least I haven't yet found it to be). 
</p>

<p>Anyway, among all the amazing features of OCaml, the two that stand out as being the most useful are pattern matching (on types) and the simplicity of defining new types and creating constructors:</p>

<pre><code class="ocaml">type astnode = 
| AndNode of astnode * astnode
| OrNode of astnode * astnode
| NotNode of astnode 
| IdNode of bool

let rec eval_node (n: astnode) = 
  match n with
  | AndNode (l, r) -> (eval_node l) && (eval_node r)
  | OrNode (l, r) -> (eval_node l) || (eval_node r)
  | NotNode l -> not (eval_node l)
  | IdNode v -> v

eval_node (AndNode (IdNode true, IdNode false)) (* returns false *)
</code></pre>

<p>Of course, the type annotation, <code class="inline">(n: astnode)</code>, is optional due to the type inference engine, but the above example shows a simple example type that might be used when defining a language to do boolean arithmetic. It's quick to see that the combination of type constructors (like the <code class="inline">IdNode</code> above) and pattern matching simplify this incredibly.
</p>

<p>But, we don't get this sort of coolness in Python. No, in Python, we can make classes, but we do not get type checking of any kind, unless of course we do it at runtime manually. That's because Python is <a href="http://en.wikipedia.org/wiki/Type_system#Dynamic_typing">dynamically typed</a>.</p>

<p>On the other hand, if we <em>really</em> want to, we can use the built in functions <code class="inline">isinstance</code> and <code class="inline">type</code> to raise errors when incompatible types are passed along to functions. This is slow, but it works. And, in some cases, like the one I'm about to show, maybe it doesn't matter, if you get certain benefits.</p>

<p>Consider a language, like before, that does boolean arithmetic. It'll support boolean <abbr title="Both true">AND</a> (&amp;), <abbr title="One or the other true">OR</abbr> (|), <abbr title="One or the other true, but not both">XOR</abbr> (^) and NOT (!). A valid expression in this language is of the form <code class="inline">t & !(f | t)</code> which evaluates to <code class="inline">false</code>.</p>

<p>I've created two different parsers for this language. In <a href="http://hg.apgwoz.com/boolinterp/file/0c592ee06c7f/bptuples.py" rel="nofollow">bptuples</a>, I create an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" title="Abstract Syntax Tree">AST</a> using Python tuples of the form <code class="inline">('AndNode', t, f)</code>. In <a href="http://hg.apgwoz.com/boolinterp/file/0c592ee06c7f/bpnodes.py" rel="nofollow">bpnodes</a>, however, I take a more elegant approach when building the <abbr title="Abstract Syntax Tree">AST</abbr>&mdash;I create "OCaml like" type constructors.</p>

<pre><code class="python">
ASTNode = deftype('ASTNode', ())
AndNode = deftype('AndNode', (ASTNode, ASTNode,), ASTNode)
OrNode = deftype('OrNode', (ASTNode, ASTNode,), ASTNode)
XorNode = deftype('XorNode', (ASTNode, ASTNode,), ASTNode)
NotNode = deftype('NotNode', (ASTNode,), ASTNode)
IdNode = deftype('IdNode', (bool,), ASTNode)
</code></pre>

<p>This defines all the Python classes needed at runtime. <code class="inline">deftype</code> takes up to 3 arguments. The first argument is the name of the class, the second is a tuple of classes which it can accept as arguments, and the optional third argument is a parent class to inherit from. The optional third argument is only necessary if you need multiple constructors for the same type, as in the case of our OCaml example above, and this example here.</p>

<p>The code for <code class="inline">deftype</code> is actually pretty simple:</p>

<pre><code class="python">
def deftype(name, types, extends=None):
    class _dtype(object):
        def __init__(self, *args):
            for i, a in enumerate(zip(args, self.types)):
                if isinstance(a[0], a[1]):
                    self.__setattr__('op%d' % i, a[0])
                else:
                    raise TypeError("%s expected argument of type " % \
                                        (self.__class__.__name__,
                                         str(a[1])))
    if extends:
        parents = (_dtype, extends,)
    else:
        parents = (_dtype,)
    return type(name, parents, {'types': types})
</code></pre>

<p>Basically, what it does is use the Python built-in <code class="inline">type</code> to construct a class at runtime with an attribute called <code class="inline">types</code> which holds the class names of the expected arguments to the constructor of the type. On construction, the arguments are enumerated and attributes are created of the form <code class="inline">op0</code>...<code class="inline">opN</code>.</p>

<p>It's a mouthful, for sure, but all that means is that when we construct a new <code class="inline">AndNode</code>, we are sure that the arguments the instance was created with are indeed <code class="inline">ASTNode</code>s, and those nodes are accessible at <code class="inline">op0</code> and <code class="inline">op1</code>.</p>

<p>At a cursory glance, you might be thinking, "but what does this actually do for us?" Well, honestly, not much, but you do get to abstract out some more runtime type checking and do dynamic dispatch with the help of some Python decorators. Observe:</p>

<pre><code class="python">
@multimethod(AndNode)
def interpret(ast):
    return interpret(ast.op0) and interpret(ast.op1)

@multimethod(XorNode)
def interpret(ast):
    left = interpret(ast.op0)
    right = interpret(ast.op1)
    return (left or right) and not (left and right)

@multimethod(OrNode)
def interpret(ast):
    return interpret(ast.op0) or interpret(ast.op1)

@multimethod(NotNode)
def interpret(ast):
    return not interpret(ast.op0)

@multimethod(IdNode)
def interpret(ast):
    return ast.op0
</code></pre>

<p>That's the entire interpreter to walk the AST and evaluate boolean expressions, and is called via <code class="inline">interpret(parseBool(tokenizer('t & ! (t | f)')))</code>.</p>

<p>In the tuple version, it's actually shorter when you use <code class="inline">if</code> statements, but this approach is much more readable in my opinion. The <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=101605">multimethod decorator</a> runs the correct <code class="inline">interpret</code> based on the types of arguments.</p>

<p> This is as close to OCaml like  pattern matching that we're going to get, at least as far as I know how to get, but it's sort of cool, and definitely a hack.</p>


]]></content></entry>
<entry><title>The Failure of Bayesian Filtering For Automated Screening of Med School Applications</title><link href="/2008/Sep/18/bayesian-failure.html"/><id>md5:f10c2840e1d10debae66e6dfe782f90e</id><updated>2008-09-18T22:20:00Z</updated><content type="html"><![CDATA[<p>
<span class="preamble">OK, I'll admit it. I <em>failed</em>. I failed to apply a simple Bayes net to a simple problem, which humans can do with a little bit of reading and some coffee.</span>
</p>

<p>At my place of employment, we have a problem. Our solutions to this problem, right now, relies too much on time consuming human interaction and, certainly, too much on the knowledge gained from history. The problem is that of a multitude of pre-med students hoping to be granted the opportunity to come here for an interview regarding admission into the world renouned medical school. </p>

<p>It'd be both impractical and impossible to interview everyone, so there exists a rigorous screening process before interview decisions are made. We have some tools that automatically look through an application and parameterise it for easier searching. We also have some tools that automatically weed out applications that have extremely low <abbr title="Medical College Admission Test">MCAT</abbr>s and <abbr title="Grade Point Average">GPA</abbr>s. By and large, these processes get the number of applications the screening team must thoroughly inspect down to a manageable number of very competitive candidates, but the number is still too large.</p>

<p>Now, immediately you must be thinking, <q>Why can't they just change the parameters to eliminate more people?</q> And the answer is that we could, but what the screeners look for isn't just numeric. The screeners are looking at many different aspects of the candidates past. Many of the students accepted to the school weren't the top students in their class. They certainly weren't horrible students academically, but they had diverse experiences in school, or otherwise, that the professors of the school felt qualified them as being an outstanding addition to this premier institution.</p>

<p>As a programmmer, I see this as a fun and interesting challenge. A challenge where I can apply some "computer sciency" things to add just a touch of intelligence to the automated process and filter out those candidates that maybe are not as "rock star" as they appear in numbers. My first though was to use a <a href="http://en.wikipedia.org/wiki/Naive_Bayes_classifier" title="Naive Bayes on WikiPedia">Naive Bayes classifier</a>.</p>

<p>A medical school applicant writes a lot. <a href="http://www.aamc.org" title="American Medical College Application Service">AMCAS</a> asks of students to submit information on past experiences (e.g. research, personal, travel, professional, community service), and for information about publications they've (co)authored, and a personal statement. In addition, applicants submit some other free form text to us directly. This data seems like a natural fit for training a classifier.</p>

<p>So, I go with it; I mention to my project manager that it might be possible to probabalistically predict the scores generated from the manual, time consuming screening process, using historic applicant entered data as a training corpus. As his eyes lit up, I explained the basic idea of a Naive Bayes classifier and said, <q>it's the basis of many SPAM filters.</q> This was enough to sell it to him, and to our immediate client, the Admissions office. I now had permission to play around and see how well I could predict the past.</p>

<p>From the database, I pulled out as much data as I possible could and build two buckets; successful and unsuccessful. Successful candidates had the property that they were all likely invited for interviews, and well unsuccessful weren't. I tried to make it roughly even, taking as many of the least successful candidates as I could to match as closely as possible to the number of successful candidates. I proceeded to write a basic Naive Bayes classifier, made it general enough that I could add and subtract some ideas easily, and setup a simple cross validation. I was set.</p>

<p>I couldn't have been more excited to see things pass the screen like:</p>

<pre><code>Run 0 -------------
Good: S 57 / F 17 = 0.773333
Bad: S 22 / F 49 = 0.319444
Run 1 -------------
Good: S 71 / F 3 = 0.960000
Bad: S 8 / F 63 = 0.125000
Run 2 -------------
Good: S 70 / F 4 = 0.946667
Bad: S 13 / F 58 = 0.194444
Run 3 -------------
Good: S 61 / F 13 = 0.826667
Bad: S 12 / F 59 = 0.180556</code></pre>

<p>But the results didn't look good to me. The first line "Good: ... " states that of the 74 attempts at classifying a known "successful" candidate only 57 were predicted correctly. Even worse, only 22 of the "unsuccessful" candidates were predicted successfully. Surely, this could be fixed, I thought. It's simply a matter of doing better smoothing, and eliminating the common words with high frequencies. </p>

<p>Still nothing. Stem the words? Worse. Eliminate more words? Worse. Smoothing? No better. Discouragement sets in.</p>

<p>I look into it a bit further and discover something interesting. All these essays, all these experiences sound exactly the same! They all talk about community service and late nights in the research labs. They all discuss the fact that for as long as they can remember they've wanted to become physicians. It's as if all the candidates are the same person.</p>

<p>They aren't. Unlike a note from my wife and an offer for viagra or cialis, their goals are the same, and their language is in the same domain.</p>

<p>Seems like I need another idea.</p>
]]></content></entry>
<entry><title>Announcing the Return of Modest</title><link href="/2008/Sep/08/announcing-modest.html"/><id>md5:46bc9058d3455dcb80e42e14e83535bd</id><updated>2008-09-08T00:00:00Z</updated><content type="html"><![CDATA[<p><span class="preamble">As a programmer, I pride myself in being lazy. This might at first seem like a horrible thing to take pride in but hear me out.</span></p>

<p>Let me give you an example related to my day job. Two weeks ago I was given a CSV file containing 2000+ rows with the header row of <code class="inline">original_request_id,request_id,first_name,last_name,amount,status_cd</code>. Inside was a list of credit card transactions that were taken from development and migrated to the production credit card processor. But, as luck would have it some credit credit cards had expired, had insufficient funds, or were just flat out denied when the charge authorization was requested during this migration. </p>

<p>So, obviously, someone had to go through and filter through this CSV file, find the entries that had succeeded and make note that the user was paid up in full. Additionally, we needed to filter the failed results, find the user and tell them there was a problem with their payment. In other words, we needed 2 lists&mdash;payees and repayors. </p>

<p>At this point I knew I had a few choices. I could fire up GNU Emacs, run <code class="inline">M-x keep-lines</code>, save the buffer, undo and then run <code class="inline">M-x flush-lines</code>, save and have two lists. Then of course, I'd have to spend the afternoon looking up everyone in the list and recording the proper data changes.</p>

<p>The other option would be to be lazy and write about 5 lines of Python and turn the 2000+ row CSV file into 2 SQL queries, which Oracle would happily run for me. The work it takes to craft the 5 lines, would almost certainly be less work than the manual labor.</p>

<p>Naturally, as the first sentence suggests I choose the second option.</p>

<pre><code class="python">
lines = open('records.csv').readlines()[1:]
payors = [x.split(',')[0] for x in lines if '(Accept)' in x]
repays = [x.split(',')[0] for x in lines if '(Failure)' in x]
print "UPDATE PAID SET paid = 1 WHERE pid IN (select pid from TRANS WHERE rid IN ('%s');" % ','.join(["'" + i + "'" for i in payors])
print "UPDATE PAID SET paid = 0 WHERE pid IN (select pid from TRANS WHERE rid IN ('%s');" % ','.join(["'" + i + "'" for i in repays])
</code></pre>

<p>But, you gotta ask yourself, "is this laziness?"</p>

<h3>What Does This Have to Do With Modest?</h3>

<p>There's a concern I have with some types of software where more work is being done than is really necessary. The definitive example is of course blogs.
</p>

<p>Back in the early days of blogs, the writer was tasked at creating a new static page (probably from a template) and hand crafting the HTML that made up the new post. If the blog had comments, they might include a file using <abbr title="Server Side Includes">SSI</abbr> to display the comments, and the CGI script that processed comments would do nothing more than write the comment to the file included. And even when the first blog "engines" came out, which automated the tedious process of copying the template and hand assembling the new page and all of the indexes, they were just a series of forms and CGI scripts that took the values of some form fields and generated the static HTML files for you.
</p>

<p>But somewhere along the lines, the process of compiling a blog was over engineered. Writers felt that their posts needed to be <abbr title="Just in Time">JIT</abbr> compiled, which required that blogs actually serve dynamic HTML rather than just serving a static file. Suddenly, storing posts in databases became the norm, which resulted in high loads on servers when sites like <a href="http://slashdot.org/">Slashdot</a> published a link to your site on their homepage.</p>

<p>The Slashdot Effect, as it became known, resulted in many things like the community mirroring of sites, and eventually, public <abbr title="Content Distribution Networks">CDN</abbr>s started popping up like <a href="http://www.coralcdn.org/">Coral Cache</a> to mirror the site automatically. This is mostly unnecessary when you consider the fact that had blogs not been so reliant on a database backend, servers could have withstood a much higher load, and stood up by themselves under many situations.</p>

<p>In fact, the first thing that most shared hosting companies will do in the event of the Slashdot Effect, or Digg Effect, seems to be to take a static snapshot of the page and serve that.</p>

<p>Modest cuts out the middle man. Everything is served as static HTML, because I believe that JIT compiling blog engines do too much work. Modest doesn't require a database, doesn't generate content on the fly, but with a little luck, some time and a little ingenuity, I feel that it will become as full featured a blog engine as you can get for command line use. </p>

<h3>Return?</h3>

<p>A few years ago, I wrote an initial version of Modest, in Python, which generated static HTML from simple text files. It worked fairly well, but wasn't flexible. The date of the post was based on the files <code class="inline">ctime</code>, and there was no way to really add metadata to the post. This worked fine, but in some cases (e.g. <code class="inline">cp post.txt post.txt.bak</code>) you simply loose the date information. The quick fix I came up with was to cache the <code class="inline">ctime</code> in another file, which was just a mess. And of course, this only solved storing one piece of metadata.</p>

<p>The new version of Modest, which will be released for public consumption very soon, had unlimited metadata potential, because the entry actually contains a spot for it. Each post is defined simply by doing:</p>

<pre><code>
Title: Some Post
Date: 2008-10-10 10:10:32
Tags: something, strange, neighborhood, ghostbusters
Published: True
UnknownMetaData1: gets converted to a string
UnknownMetaData2: False
---
Post body goes here, but note&mdash;the Date field becomes a Python datetime, 
and Published becomes a Python boolean True. These values become available 
in the template's context. 
</code></pre>

<p>Because those variables become available in the template's context, interesting things can now occur. Suddenly you can, without changing your database schema, make certain posts behave differently, just by including a bit more metadata and adding the appropriate logic to your templates. It's not very <abbr title="Model-View-Controller">MVC</abbr>, but who cares about that? The point is, you get flexibility for free, and flexibility is another part of being lazy. This all happens to tie into another project, but we're out of time for now. Look for more of Modest soon.
</p>

]]></content></entry>

</feed>